/*
Jinzhong_Nest Web wblist.js
By @Phy25 - 2014/11/10
Just copy from index.js, including #content.box styling and inline comment
Other credits left through the script
*/
$(function(){function d(a){var b,c,d;a.attr("id")&&(a.find("a.btn.repost").click(function(){var a,b,c;return $("#msg-id-inline-callback.active").length?!1:$("#inline-form").is(".active")&&"repost"==$("#inline-form-type").val()&&(a=$(this).closest(".box, blockquote"),b=a.attr("id")||a.data("id"),$("#inline-form-parent-id").val()==b)?(e(),!1):(c=$("#inline-form").appendTo($(this).closest(".box").find(".box-upper")).show(),f(c,$(this).closest(".box, blockquote"),"repost"),!1)}),a.find("a.btn.comment").click(function(){var a,b,c;return $("#msg-id-inline-callback.active").length?!1:$("#inline-form").is(".active")&&"comment"==$("#inline-form-type").val()&&(a=$(this).closest(".box, blockquote"),b=a.attr("id")||a.data("id"),$("#inline-form-parent-id").val()==b)?(e(),!1):(c=$("#inline-form").appendTo($(this).closest(".box").find(".box-upper")).show(),f(c,$(this).closest(".box, blockquote"),"comment"),!1)})),b=a.find(".box-content-e p"),b.eq(0).html(function(b,c){var e,f,g,d=c.match(/^(.*)►(.+)$/);return null!==d?(e=$.trim(d[2]),f=$.trim(d[1])):(g=c.match(/^(.*)「(.+)」$/),null!==g?(e=$.trim(g[2]),f=$.trim(g[1])):(e="Admin",f=c)),"wx"==e&&(e="WeChat"),"web"==e&&(e="Web"),a.find("span.source").text("#"+e),$.trim(f)}),b.html(function(a,b){return b.replace(/https?\:\/\/[0-9a-zA-Z]([-.\w]*[0-9a-zA-Z])*(:(0-9)*)*(\/?)([a-zA-Z0-9\-\.\?\,\'\/\\\+&amp;%\$#_]*)?/g,function(a){return'<a href="'+a+'" target="_blank" class="url">'+a+"</a>"}).replace(/@([\u4e00-\u9fa5a-zA-Z0-9_-]{1,30})/g,function(a,b){return'<a href="http://weibo.com/n/'+encodeURIComponent(b)+'" target="_blank" class="mention">@'+b+"</a>"})}),c=function(){$(this).wrap('<div class="wbimg-zoomdiv" />');var b=$('<p class="small"></p>'),c=$(this);return $('<a href="javascript:void(0)">返回</a>').click(function(){return $(this).closest(".wbimg-zoomdiv").find("img").click(),!1}).appendTo(b),$('<a href="#" target="_blank">原图</a>').attr("href",c.data("large-img")).appendTo(b),c.before(b).off("click").on("click",d),c.find("img:first").data("small-img",c.find("img").attr("src")).attr("src",c.attr("href")).attr("title","点击返回").addClass("middle"),!1},d=function(){var a=$(this).closest(".wbimg-zoomdiv"),b=$(this).detach().off("click").on("click.zoomin",c);return b.find("img").attr("src",b.find("img").data("small-img")).attr("title","点击放大"),a.replaceWith(b),!1},a.find("a.wbimg-zoom").attr("title","点击放大").on("click.zoomin",c)}function e(){$("#inline-form").removeClass("active").slideUp(),$("#reply").blur()}function f(a,b,c){"object"==typeof b?($p=b,b=$p.attr("id")||$p.data("id")):$p=!1,a.find("#inline-form-type").val(c),a.find("#inline-form-parent-id").val(b),a.addClass("active"),"comment"==c&&(a.find("span.typetext").text("评论"),a.find("#inline-form-submit").text("匿名评论")),"repost"==c&&(a.find("span.typetext").text("转发"),a.find("#inline-form-submit").text("匿名转发")),$p&&a.find("a.backlink").attr("href",$p.find("a.morelink:last").attr("href")+"?type="+c),$("#reply").focus()}function g(b,c,d,e,f){var g;d||(d="error"),void 0===e&&(e=5e3),$("#msg-id-"+c).length?(g=$("#msg-id-"+c).find("p:first").text(b).end(),clearTimeout(a["msg-id-"+c]),f&&f.after(g)):(g=$('<div id="msg-id-'+c+'" class="box pointer '+d+'"><div class="box-content center"><p>'+$("<div/>").text(b).html()+"</p></div></div>").on("click",function(){$(this).remove()}),f?f.after(g):g.prependTo("#content")),0!==e&&(a["msg-id-"+c]=setTimeout(function(){g.remove()},e))}function i(a){return $("a.ajax",a).click(function(a){var b,c,d;return"undefined"!=typeof operamini?!0:(a.preventDefault(),$("#ajaxContent").length||$("#content").before('<div id="ajaxContent"></div>'),b=$("#ajaxContent").html('<div class="box progress-bar-striped active"><div class="box-content center"><p>正在加载</p></div></div>'),window.scrollTo(0,0),c=function(a){var c;b.empty().hide(),c="object"==typeof a?$(a):$("<div>").append(a.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"")),b.append(i(c.find("#content").children())).slideDown()},d=function(a){var c=b.find(".box.active:first");c.addClass("error pointer").removeClass("progress-bar-striped active").find("p:first").text("载入错误（"+a.statusText+", "+a.status+"）"),c.click(function(){return $(this).remove(),!1})},$.get(this.href).done(c).error(d),!1)}),a}var a={},b=!0;$("#reply-weibo-form").on("keydown",function(a){return 27==a.keyCode?(e(),a.preventDefault(),!1):13==a.keyCode&&1==a.ctrlKey?($("#reply-weibo-form").submit(),a.preventDefault(),!1):void 0}),$("#reply").on("keydown change",function(){checkWeiboWordBG(this.value,"cr",$(this).closest(".box"))}),$("#reply-weibo-form").submit(function(c){var d,f,h;return"undefined"!=typeof operamini?!0:(d=$(this),c.preventDefault(),0==wbGetLength($("#reply").val())?($("#reply").val("").focus(),!1):wbGetLength($("#reply").val())>136?(g("字数过多，请不要做话痨 :)","new-weibo-length","error",3e3,$(this).closest(".box")),$("#reply").focus(),!1):(f=function(b){var c,e,f;if("okay"==b||"fakeajax"==b)$("#msg-id-inline-callback").removeClass("progress-bar-striped active").addClass("success pointer").click(function(){return $(this).remove(),!1}).find("p:first").text("发布成功"),c=d.closest(".box-upper"),e=c.find("#inline-form-type").val(),c.find("a.btn."+e).text(function(a,b){var c=b.match(/^(.+)\((\d+)\)$/);return null==c?b:c[2]?c[1]+"("+(+c[2]+1)+")":void 0}),a["inline-callback"]=setTimeout(function(){$("#msg-id-inline-callback").remove()},5e3),$("#reply-weibo-form")[0].reset();else{if(0==b.indexOf("gap"))return f=b.split(".")[1],h({},"为防刷屏，请等待 "+f+" 秒，再发布新树洞"),!1;if("other"==b)return h({},"other"),!1;h({},"程序错误："+b)}},h=function(b,c){"other"==c&&(c="字数过多，或者微博系统繁忙等"),$("#msg-id-inline-callback").removeClass("progress-bar-striped active"),$("#inline-form").show(),$("#reply").focus(),$("#msg-id-inline-callback").addClass("error pointer").click(function(){return $(this).remove(),!1}).find("p:first").text("发布失败（"+c+"）"),a["inline-callback"]=setTimeout(function(){$("#msg-id-inline-callback").remove()},1e4)},$("#msg-id-inline-callback").remove(),$(this).closest(".box").after('<div id="msg-id-inline-callback" class="box progress-bar-striped active"><div class="box-content center"><p>正在发布</p></div></div>'),e(),clearTimeout(a["inline-callback"]),b?setTimeout(function(){Math.random()>.3?f("fakeajax"):h({},"为防刷屏，请等待 3 秒，再发布新树洞")},2e3):$(this).ajaxSubmit({data:{ajax:!0},dataType:"text",success:f,error:h}),!1))}),$("#content .box").each(function(a,b){d($(b))}),i(document)});