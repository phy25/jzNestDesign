/*
Jinzhong_Nest Web wblist.js
By @Phy25 - 2014/11/14
Just copy from index.js, including #content.box styling and inline comment
Other credits left through the script
*/
$(function(){function d(a){a.attr("id")&&(a.find("a.btn.repost").click(function(){if($("#msg-id-inline-callback.active").length)return!1;if($("#inline-form").is(".active")&&"repost"==$("#inline-form-type").val()){var a=$(this).closest(".box, blockquote"),b=a.attr("id")||a.data("id");if($("#inline-form-parent-id").val()==b)return e(),!1}var c=$("#inline-form").appendTo($(this).closest(".box").find(".box-upper")).show();return f(c,$(this).closest(".box, blockquote"),"repost"),!1}),a.find("a.btn.comment").click(function(){if($("#msg-id-inline-callback.active").length)return!1;if($("#inline-form").is(".active")&&"comment"==$("#inline-form-type").val()){var a=$(this).closest(".box, blockquote"),b=a.attr("id")||a.data("id");if($("#inline-form-parent-id").val()==b)return e(),!1}var c=$("#inline-form").appendTo($(this).closest(".box").find(".box-upper")).show();return f(c,$(this).closest(".box, blockquote"),"comment"),!1}));var b=a.find(".box-content-e p");b.eq(0).html(function(b,c){c=c.replace(/\r|\n/g,"");var e,f,d=c.match(/^(.*)\u25ba(.+)$/);if(null!==d)e=$.trim(d[2]),f=$.trim(d[1]);else{var g=c.match(/^(.*)\u300c(.+)\u300d$/);null!==g?(e=$.trim(g[2]),f=$.trim(g[1])):(e="Admin",f=c)}return"wx"==e&&(e="WeChat"),"web"==e&&(e="Web"),a.find("span.source").text("#"+e),$.trim(f)}),b.html(function(a,b){return b.replace(/https?\:\/\/[0-9a-zA-Z]([-.\w]*[0-9a-zA-Z])*(:(0-9)*)*(\/?)([a-zA-Z0-9\-\.\?\,\'\/\\\+&amp;%\$#_]*)?/g,function(a){return'<a href="'+a+'" target="_blank" class="url">'+a+"</a>"}).replace(/@([\u4e00-\u9fa5a-zA-Z0-9_-]{1,30})/g,function(a,b){return'<a href="http://weibo.com/n/'+encodeURIComponent(b)+'" target="_blank" class="mention">@'+b+"</a>"})});var c=function(){$(this).wrap('<div class="wbimg-zoomdiv" />');var b=$('<p class="small"></p>'),c=$(this);return $('<a href="javascript:void(0)">\u8fd4\u56de</a>').click(function(){return $(this).closest(".wbimg-zoomdiv").find("img").click(),!1}).appendTo(b),$('<a href="#" target="_blank">\u539f\u56fe</a>').attr("href",c.data("large-img")).appendTo(b),c.before(b).off("click").on("click",d),c.find("img:first").data("small-img",c.find("img").attr("src")).attr("src",c.attr("href")).attr("title","\u70b9\u51fb\u8fd4\u56de").addClass("middle"),!1},d=function(){var a=$(this).closest(".wbimg-zoomdiv"),b=$(this).detach().off("click").on("click.zoomin",c);return b.find("img").attr("src",b.find("img").data("small-img")).attr("title","\u70b9\u51fb\u653e\u5927"),a.replaceWith(b),!1};a.find("a.wbimg-zoom").attr("title","\u70b9\u51fb\u653e\u5927").on("click.zoomin",c)}function e(){$("#inline-form").removeClass("active").slideUp(),$("#reply").blur()}function f(a,b,c){"object"==typeof b?($p=b,b=$p.attr("id")||$p.data("id")):$p=!1,a.find("#inline-form-type").val(c),a.find("#inline-form-parent-id").val(b),a.addClass("active"),"comment"==c&&(a.find("span.typetext").text("\u8bc4\u8bba"),a.find("#inline-form-submit").text("\u533f\u540d\u8bc4\u8bba")),"repost"==c&&(a.find("span.typetext").text("\u8f6c\u53d1"),a.find("#inline-form-submit").text("\u533f\u540d\u8f6c\u53d1")),$p&&a.find("a.backlink").attr("href",$p.find("a.morelink:last").attr("href")+"?type="+c),$("#reply").focus()}function g(b,c,d,e,f){if(!d)var d="error";if(void 0===e)var e=5e3;if($("#msg-id-"+c).length){var g=$("#msg-id-"+c).find("p:first").text(b).end();clearTimeout(a["msg-id-"+c]),f&&f.after(g)}else{var g=$('<div id="msg-id-'+c+'" class="box pointer '+d+'"><div class="box-content center"><p>'+$("<div/>").text(b).html()+"</p></div></div>").on("click",function(){$(this).remove()});f?f.after(g):g.prependTo("#content")}0!==e&&(a["msg-id-"+c]=setTimeout(function(){g.remove()},e))}function i(a){return $("a.ajax",a).click(function(a){if("undefined"!=typeof operamini)return!0;a.preventDefault(),$("#ajaxContent").length||$("#content").before('<div id="ajaxContent"></div>');var b=$("#ajaxContent").html('<div class="box progress-bar-striped active"><div class="box-content center"><p>\u6b63\u5728\u52a0\u8f7d</p></div></div>');window.scrollTo(0,0);var c=function(a){if(b.empty().hide(),"object"==typeof a)var c=$(a);else var c=$("<div>").append(a.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,""));b.append(i(c.find("#content").children())).slideDown()},d=function(a){var c=b.find(".box.active:first");c.addClass("error pointer").removeClass("progress-bar-striped active").find("p:first").text("\u8f7d\u5165\u9519\u8bef\uff08"+a.statusText+", "+a.status+"\uff09"),c.click(function(){return $(this).remove(),!1})};return $.get(this.href).done(c).error(d),!1}),a}var a={},b=!1;$("#reply-weibo-form").on("keydown",function(a){return 27==a.keyCode?(e(),a.preventDefault(),!1):13==a.keyCode&&1==a.ctrlKey?($("#reply-weibo-form").submit(),a.preventDefault(),!1):void 0}),$("#reply").on("keydown change",function(){checkWeiboWordBG(this.value,"cr",$(this).closest(".box"))}),$("#reply-weibo-form").submit(function(c){if("undefined"!=typeof operamini)return!0;var d=$(this);if(c.preventDefault(),0==wbGetLength($("#reply").val()))return $("#reply").val("").focus(),!1;if(wbGetLength($("#reply").val())>136)return g("\u5b57\u6570\u8fc7\u591a\uff0c\u8bf7\u4e0d\u8981\u505a\u8bdd\u75e8 :)","new-weibo-length","error",3e3,$(this).closest(".box")),$("#reply").focus(),!1;var f=function(b){if("okay"==b||"fakeajax"==b){$("#msg-id-inline-callback").removeClass("progress-bar-striped active").addClass("success pointer").click(function(){return $(this).remove(),!1}).find("p:first").text("\u53d1\u5e03\u6210\u529f");var c=d.closest(".box-upper"),e=c.find("#inline-form-type").val();c.find("a.btn."+e).text(function(a,b){var c=b.match(/^(.+)\((\d+)\)$/);return null==c?b:c[2]?c[1]+"("+(+c[2]+1)+")":void 0}),a["inline-callback"]=setTimeout(function(){$("#msg-id-inline-callback").remove()},5e3),$("#reply-weibo-form")[0].reset()}else{if(0==b.indexOf("gap")){var f=b.split(".")[1];return h({},"\u4e3a\u9632\u5237\u5c4f\uff0c\u8bf7\u7b49\u5f85 "+f+" \u79d2\uff0c\u518d\u53d1\u5e03\u65b0\u6811\u6d1e"),!1}if("other"==b)return h({},"other"),!1;h({},"\u7a0b\u5e8f\u9519\u8bef\uff1a"+b)}},h=function(b,c){"other"==c&&(c="\u5b57\u6570\u8fc7\u591a\uff0c\u6216\u8005\u5fae\u535a\u7cfb\u7edf\u7e41\u5fd9\u7b49"),$("#msg-id-inline-callback").removeClass("progress-bar-striped active"),$("#inline-form").show(),$("#reply").focus(),$("#msg-id-inline-callback").addClass("error pointer").click(function(){return $(this).remove(),!1}).find("p:first").text("\u53d1\u5e03\u5931\u8d25\uff08"+c+"\uff09"),a["inline-callback"]=setTimeout(function(){$("#msg-id-inline-callback").remove()},1e4)};return $("#msg-id-inline-callback").remove(),$(this).closest(".box").after('<div id="msg-id-inline-callback" class="box progress-bar-striped active"><div class="box-content center"><p>\u6b63\u5728\u53d1\u5e03</p></div></div>'),e(),clearTimeout(a["inline-callback"]),b?setTimeout(function(){Math.random()>.3?f("fakeajax"):h({},"\u4e3a\u9632\u5237\u5c4f\uff0c\u8bf7\u7b49\u5f85 3 \u79d2\uff0c\u518d\u53d1\u5e03\u65b0\u6811\u6d1e")},2e3):$(this).ajaxSubmit({data:{ajax:!0},dataType:"text",success:f,error:h}),!1}),$("#content .box").each(function(a,b){d($(b))}),i(document)});