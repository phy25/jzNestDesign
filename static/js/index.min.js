/*
Jinzhong_Nest Web index.js
By @Phy25 - 2015/3/18
*/
$(function(){function f(a,b,c){var d=!1;/@[\u4e00-\u9fa5a-zA-Z0-9_-]{1,30}/.test(a)&&("cr"==b?($("#reply").val(a.replace(/@(.)/g,"@ $1")),m("\u4e3a\u4e86\u907f\u514d\u9a9a\u6270\uff0c\u8bc4\u8bba / \u8f6c\u53d1\u4e0d\u80fd @ \u4eba\uff0c\u5982\u6709\u9700\u8981\u8bf7\u5b9e\u540d\u64cd\u4f5c\u3002\u4f60\u53ef\u4ee5\u7ee7\u7eed\u53d1\u5e03\u672c\u5185\u5bb9\u3002","weibo-content-hint","error",5e3,c),d=!0):"undefined"!=typeof localStorage&&"off"!==localStorage.jzth_mention_hint&&(n("\u5728 @ \u540e\u8f93\u5165\u6635\u79f0\u540e\uff0c\u8bf7\u8bb0\u5f97\u6253\u7a7a\u683c\uff0c\u5426\u5219 @ \u4e0d\u5230\u4eba\u3002 "+("undefined"!=typeof localStorage?'<a href="javascript:void(0)" id="msg-id-weibo-mention-btn">\u4e0d\u518d\u63d0\u9192</a>':""),"weibo-content-hint","error",8e3,c),$("#msg-id-weibo-mention-btn").on("click",function(){localStorage.jzth_mention_hint="off",$("#msg-id-weibo-content-hint").remove()}),d=!0)),/@.+[^\u4e00-\u9fa5a-zA-Z0-9_-]/.test(a)&&($("#msg-id-weibo-content-hint").remove(),d=!1),(-1!=a.indexOf("\u6811\u6d1e")||-1!=a.indexOf("\u6d1e\u4e3b")||-1!=a.indexOf("@ \u91d1\u4e2d_Nest")||-1!=a.indexOf("@\u91d1\u4e2d_Nest")&&!d)&&n('\u6811\u6d1e\u95ee\u9898\uff0c\u4e0d\u59a8<a href="#contact-block">\u76f4\u63a5\u8ddf\u6d1e\u4e3b\u90ae\u4ef6\u4ea4\u6d41</a>\u3002\u4f60\u53ef\u4ee5\u7ee7\u7eed\u53d1\u5e03\u672c\u5185\u5bb9\u3002',"weibo-content-hint","error",5e3,c)}function i(a){a.attr("id")&&(a.find("a.btn.repost").click(function(){if($("#msg-id-inline-callback.active").length)return!1;if($("#inline-form").is(".active")&&"repost"==$("#inline-form-type").val()){var a=$(this).closest(".box, blockquote"),b=a.attr("id")||a.data("id");if($("#inline-form-parent-id").val()==b)return j(),!1}var c=$("#inline-form").appendTo($(this).closest(".box").find(".box-upper")).show();return k(c,$(this).closest(".box, blockquote"),"repost"),!1}),a.find("a.btn.comment").click(function(){if($("#msg-id-inline-callback.active").length)return!1;if($("#inline-form").is(".active")&&"comment"==$("#inline-form-type").val()){var a=$(this).closest(".box, blockquote"),b=a.attr("id")||a.data("id");if($("#inline-form-parent-id").val()==b)return j(),!1}var c=$("#inline-form").appendTo($(this).closest(".box").find(".box-upper")).show();return k(c,$(this).closest(".box, blockquote"),"comment"),!1}));var b=a.find(".box-content-e p");b.eq(0).html(function(b,c){c=c.replace(/\r|\n/g,"");var e,f,d=c.match(/^(.*)\u25ba(.+)$/);if(null!==d)e=$.trim(d[2]),f=$.trim(d[1]);else{var g=c.match(/^(.*)\u300c(.+)\u300d$/);null!==g?(e=$.trim(g[2]),f=$.trim(g[1])):(e="Admin",f=c)}return"wx"==e&&(e="WeChat"),"web"==e&&(e="Web"),a.find("span.source").text("#"+e),$.trim(f)}),b.html(function(a,b){return b=b.replace(/https?\:\/\/[0-9a-zA-Z]([-.\w]*[0-9a-zA-Z])*(:(0-9)*)*(\/?)([a-zA-Z0-9\-\.\?\,\'\/\\\+&amp;%\$#_]*)?/g,function(a){return'<a href="'+a+'" target="_blank" class="url">'+a+"</a>"}).replace(/@([\u4e00-\u9fa5a-zA-Z0-9_-]{1,30})/g,function(a,b){return'<a href="http://weibo.com/n/'+encodeURIComponent(b)+'" target="_blank" class="mention">@'+b+"</a>"}),emoji?emoji.replace_emoticons(emoji.replace_colons(b)):b});var c=function(){$(this).wrap('<div class="wbimg-zoomdiv" />');var b=$('<p class="small"></p>'),c=$(this);return $('<a href="javascript:void(0)">\u8fd4\u56de</a>').click(function(){return $(this).closest(".wbimg-zoomdiv").find("img").click(),!1}).appendTo(b),$('<a href="#" target="_blank">\u539f\u56fe</a>').attr("href",c.data("large-img")).appendTo(b),c.before(b).off("click").on("click",d),c.find("img:first").data("small-img",c.find("img").attr("src")).attr("src",c.attr("href")).attr("title","\u70b9\u51fb\u8fd4\u56de").addClass("middle"),!1},d=function(){var a=$(this).closest(".wbimg-zoomdiv"),b=$(this).detach().off("click").on("click.zoomin",c);return b.find("img").attr("src",b.find("img").data("small-img")).attr("title","\u70b9\u51fb\u653e\u5927"),a.replaceWith(b),!1};a.find("a.wbimg-zoom").attr("title","\u70b9\u51fb\u653e\u5927").on("click.zoomin",c)}function j(){$("#inline-form").removeClass("active").slideUp(),$("#reply").blur()}function k(a,b,c){"object"==typeof b?($p=b,b=$p.attr("id")||$p.data("id")):$p=!1,a.find("#inline-form-type").val(c),a.find("#inline-form-parent-id").val(b),a.addClass("active"),"comment"==c&&(a.find("span.typetext").text("\u8bc4\u8bba"),a.find("#inline-form-submit").text("\u533f\u540d\u8bc4\u8bba")),"repost"==c&&(a.find("span.typetext").text("\u8f6c\u53d1"),a.find("#inline-form-submit").text("\u533f\u540d\u8f6c\u53d1")),$p&&a.find("a.backlink").attr("href",$p.find("a.morelink:last").attr("href")+"?type="+c),$("#reply").focus()}function l(a,b){a.source||(a.source="Web");var c='<div class="box"'+(a.id?' id="'+a.id+'"':"")+'><div class="box-content-e"><p>'+$("<div/>").text(a.content).html()+'</p></div><div class="box-upper"><div class="left time"><p><time>'+a.createdAt+'</time> <span class="source">#'+a.source+'</span> <a href="'+a.link+'" target="_blank" class="btn morelink" title="\u8fd4\u56de\u5fae\u535a\u770b\u56fe">\u8be6\u7ec6</a></p></div><div class="right"><p><a href="'+a.link+'?type=repost" class="btn repost">\u8f6c\u53d1('+a.repCount+')</a><a href="'+a.link+'?type=comment" class="btn comment">\u8bc4\u8bba('+a.cmtCount+")</a></p></div></div></div>";if(b){var d=$(c);return i(d),d}return c}function m(b,c,d,e,f){if(!d)var d="error";if(void 0===e)var e=5e3;if($("#msg-id-"+c).length){var g=$("#msg-id-"+c).find("p:first").text(b).end();clearTimeout(a["msg-id-"+c]),f&&f.after(g)}else{var g=$('<div id="msg-id-'+c+'" class="box pointer '+d+'"><div class="box-content center"><p>'+$("<div/>").text(b).html()+"</p></div></div>").on("click",function(){$(this).remove()});f?f.after(g):g.prependTo("#content")}0!==e&&(a["msg-id-"+c]=setTimeout(function(){g.remove()},e))}function n(b,c,d,e,f){if(!d)var d="error";if(void 0===e)var e=5e3;if($("#msg-id-"+c).length){var g=$("#msg-id-"+c).find("p:first").html(b).end();clearTimeout(a["msg-id-"+c]),f&&f.after(g)}else{var g=$('<div id="msg-id-'+c+'" class="box pointer '+d+'"><div class="box-content center"><p>'+b+"</p></div></div>").on("click",function(){$(this).remove()});f?f.after(g):g.prependTo("#content")}0!==e&&(a["msg-id-"+c]=setTimeout(function(){g.remove()},e))}function o(a){return $("a.ajax",a).click(function(a){if("undefined"!=typeof operamini)return!0;a.preventDefault(),$("#ajaxContent").length||$("#content").before('<div id="ajaxContent"></div>');var b=$("#ajaxContent").html('<div class="box progress-bar-striped active"><div class="box-content center"><p>\u6b63\u5728\u52a0\u8f7d</p></div></div>');window.scrollTo(0,0);var c=function(a){if(b.empty().hide(),"object"==typeof a)var c=$(a);else var c=$("<div>").append(a.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,""));b.append(o(c.find("#content").children())).slideDown()},d=function(a){var c=b.find(".box.active:first");c.addClass("error pointer").removeClass("progress-bar-striped active").find("p:first").text("\u8f7d\u5165\u9519\u8bef\uff08"+a.statusText+", "+a.status+"\uff09"),c.click(function(){return $(this).remove(),!1})};return $.get(this.href).done(c).error(d),!1}),a}var a={},b=!1,c="3173227132",d=["\u60f3\u8bf4\u4ec0\u4e48\uff1f\u8bf7\u4e0d\u8981\u53d1\u5e03\u65e0\u610f\u4e49\u5185\u5bb9\u3002","\u60f3\u8bf4\u4ec0\u4e48\uff1f\u8bf7\u52ff\u6076\u610f\u8c29\u9a82\u3001\u5237\u5c4f\u3002","\u60f3\u8bf4\u4ec0\u4e48\uff1f\u4e0d\u9002\u5b9c\u5185\u5bb9\u53ef\u80fd\u4f1a\u88ab\u591a\u4eba\u201c\u6c42\u5220\u201d\u800c\u88ab\u81ea\u52a8\u5220\u9664\u3002","\u60f3\u8bf4\u4ec0\u4e48\uff1f\u4e5f\u53ef\u901a\u8fc7\u5fae\u4fe1\u516c\u4f17\u53f7 st_jinzhong \u4f7f\u7528 Nest\u3002","\u60f3\u8bf4\u4ec0\u4e48\uff1fNest \u9700\u8981\u4f60\u7684\u652f\u6301\uff0c\u6b22\u8fce\u652f\u4ed8\u5b9d\u6253\u8d4f~"],e=function(){var a=function(a){try{return a.replace(/^\s+|\s+$/g,"")}catch(b){return a}},b=function(a){if("undefined"==typeof a)return 0;var b=a.match(/[^\x00-\x80]/g);return a.length+(b?b.length:0)};return function(c,d){d=d||{},d.max=d.max||140,d.min=d.min||41,d.surl=d.surl||20;var e=a(c).length;if(e>0){for(var f=d.min,g=d.max,h=d.surl,i=c,j=c.match(/(http|https):\/\/[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)+([-A-Z0-9a-z\$\.\+\!\_\*\(\)\/\,\:;@&=\?~#%]*)*/gi)||[],k=0,l=0,e=j.length;e>l;l++){var m=b(j[l]);/^(http:\/\/t.cn)/.test(j[l])||(k+=/^(http:\/\/)+(weibo.com|weibo.cn)/.test(j[l])?f>=m?m:g>=m?h:m-g+h:g>=m?h:m-g+h,i=i.replace(j[l],""))}return Math.ceil((k+b(i))/2)}return 0}}();$("#new-weibo-cover").click(function(){$(this).is(".active")||(setTimeout(function(){$("#new-weibo-cover").removeClass("progress-bar-striped success error")},600),$("#new-weibo-outer").addClass("on"),$("#status").focus(),"undefined"!=typeof localStorage&&(localStorage.jzth_nwopened="on"))}),$("#new-weibo-close").click(function(){$("#new-weibo-outer").removeClass("on"),"undefined"!=typeof localStorage&&(localStorage.jzth_nwopened="off")}),$("#new-weibo-content").on("keydown",function(a){return 27==a.keyCode?($("#new-weibo-close").click(),$("#new-weibo-cover").focus(),a.preventDefault(),!1):13==a.keyCode&&1==a.ctrlKey?($("#new-weibo-form").submit(),a.preventDefault(),!1):void 0}),$("#status").on("keyup keydown paste change",function(a,b){var c=136-e(this.value);$("#new-weibo-counter").text(c)[0>c?"addClass":"removeClass"]("warning"),b||"undefined"==typeof localStorage||(localStorage.jzth_status=this.value),f(this.value,"weibo",$("#new-weibo-outer"))}).trigger("paste",[!0]);var g=Math.floor(d.length*Math.random());g==d.length&&(g=d.length-1),$("#status").attr("placeholder",placeholder[g]);var h=function(){var b=$("#pic")[0],c=b.files&&b.files[0]?b.files[0].name:b.value;if(c){$("#new-weibo-upload-btn").addClass("selected").attr("title","\u5df2\u9009\u53d6\u56fe\u7247\u6587\u4ef6 "+c),window.ActiveXObject&&!window.XMLHttpRequest?!0:!1;var e=$("#pic")[0],f=$("#new-weibo-image-prv").text("...").show()[0],g="max-width:120px;max-height:120px;display:block;";if(e.files&&e.files[0]){var h=new FileReader;h.readAsDataURL(e.files[0]),console.log(h),h.onload=function(){f.innerHTML='<img src="'+h.result+'" style="'+g+'" alt="\u4e0a\u4f20\u56fe\u7247\u9884\u89c8 '+c+'" title="\u4e0a\u4f20\u56fe\u7247\u9884\u89c8 '+c+'" />'}}$("#new-weibo-upload").hide()}else $("#new-weibo-upload-btn").removeClass("selected").attr("title","\u4e0a\u4f20\u56fe\u7247\u6587\u4ef6")};$("#pic").on("change",h).trigger("change"),$("#new-weibo-upload").hide(),$("#new-weibo-form").on("reset",function(){$("#new-weibo-image-prv").empty(),setTimeout(function(){h(),$("#status").trigger("change")},0)}),$("#new-weibo-upload-btn").click(function(){return $("#new-weibo-upload-btn").is(".selected")&&!confirm("\u60a8\u5df2\u7ecf\u9009\u62e9\u4e86\u4e00\u5f20\u56fe\u7247\uff0c\u6811\u6d1e\u4e0d\u652f\u6301\u53d1\u5e03\u591a\u5f20\u56fe\u7247\u3002\n\n\u60a8\u8981\u91cd\u65b0\u9009\u62e9\u4e0a\u4f20\u7684\u56fe\u7247\u5417\uff1f")?!1:($("#new-weibo-upload").show(),$("#pic").click(),void 0)}),$("#new-weibo-close").keyup(function(a){13==a.keyCode&&$("#new-weibo-cover").focus()}),$("#new-weibo-reset").click(function(){$("#status").focus()}),$("#new-weibo-cover").keydown(function(a){return 13==a.keyCode?($(this).click(),a.preventDefault(),!1):void 0}),$("#new-weibo-form").submit(function(d){if("undefined"!=typeof operamini)return!0;if(d.preventDefault(),0==e($("#status").val()))return $("#status").val("").focus(),d.preventDefault(),!1;if($("#new-weibo-counter").is(".warning"))return m("\u5b57\u6570\u8fc7\u591a\uff0c\u8bf7\u4e0d\u8981\u505a\u8bdd\u75e8 :)","new-weibo-length","error",3e3),$("#status").focus(),d.preventDefault(),!1;$("#msg-id-new-weibo-failure").remove();var f=function(b){if(0==b.indexOf("okay")||"fakeajax"==b){var d=b.split("."),e=!1;"fakeajax"!=b&&d[1]?(d[2]&&(e=d[2]),d=d[1]):d=!1,$("#new-weibo-cover").removeClass("progress-bar-striped active").addClass("success"),$("#new-weibo-progress").text("\u53d1\u5e03\u6210\u529f");var f=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],h=new Date,i=f[h.getMonth()],j=h.getDate(),k=h.getHours(),m=h.getMinutes(),n=h.getSeconds();10>j&&(j="0"+j),10>k&&(k="0"+k),10>m&&(m="0"+m),10>n&&(n="0"+n);var o=i+" "+j+" "+k+":"+m+":"+n;l({content:$("#status").val()+" \u300cweb\u300d",createdAt:o,cmtCount:0,repCount:0,link:"http://weibo.com/"+c+"/"+(d!==!1?d:""),id:e},!0).hide().prependTo("#content").slideDown(),a["new-weibo-callback"]=setTimeout(function(){$("#new-weibo-cover").removeClass("success")},5e3),$("#new-weibo-form")[0].reset()}else{if(0==b.indexOf("gap")){var d=b.split(".")[1];return g({},"\u4e3a\u9632\u5237\u5c4f\uff0c\u8bf7\u7b49\u5f85 "+d+" \u79d2\uff0c\u518d\u53d1\u5e03\u65b0\u6811\u6d1e"),!1}if("other"==b)return g({},"other"),!1;g({},"\u7a0b\u5e8f\u9519\u8bef\uff1a"+b)}},g=function(a,b){"other"==b&&(b="\u5b57\u6570\u8fc7\u591a\uff0c\u56fe\u7247\u683c\u5f0f\u6709\u8bef\uff0c\u6216\u5fae\u535a\u7cfb\u7edf\u7e41\u5fd9\u7b49"),$("#new-weibo-cover").removeClass("progress-bar-striped active"),$("#status").focus(),$("#new-weibo-cover").click(),m("\u53d1\u5e03\u5931\u8d25\uff08"+b+"\uff09","new-weibo-failure","error",0)};return $("#new-weibo-progress").text("\u6b63\u5728\u53d1\u5e03"),$("#new-weibo-cover").addClass("progress-bar-striped active"),$("#new-weibo-close").click(),"undefined"!=typeof localStorage&&(localStorage.jzth_nwopened="on"),$("#status").blur(),$("#msg-id-weibo-content-hint").remove(),clearTimeout(a["new-weibo-callback"]),b?setTimeout(function(){Math.random()>.3?f("fakeajax"):g({},"\u4e3a\u9632\u5237\u5c4f\uff0c\u8bf7\u7b49\u5f85 3 \u79d2\uff0c\u518d\u53d1\u5e03\u65b0\u6811\u6d1e")},2e3):$(this).ajaxSubmit({data:{ajax:!0},dataType:"text",success:f,error:g}),!1}),$("#reply-weibo-form").on("keydown",function(a){return 27==a.keyCode?(j(),a.preventDefault(),!1):13==a.keyCode&&1==a.ctrlKey?($("#reply-weibo-form").submit(),a.preventDefault(),!1):void 0}),$("#reply").on("keydown change",function(){f(this.value,"cr",$(this).closest(".box"))}),$("#reply-weibo-form").submit(function(c){if("undefined"!=typeof operamini)return!0;var d=$(this);if(c.preventDefault(),0==e($("#reply").val()))return $("#reply").val("").focus(),!1;if(e($("#reply").val())>136)return m("\u5b57\u6570\u8fc7\u591a\uff0c\u8bf7\u4e0d\u8981\u505a\u8bdd\u75e8 :)","new-weibo-length","error",3e3,$(this).closest(".box")),$("#reply").focus(),!1;var f=function(b){if("okay"==b||"fakeajax"==b){$("#msg-id-inline-callback").removeClass("progress-bar-striped active").addClass("success pointer").click(function(){return $(this).remove(),!1}).find("p:first").text("\u53d1\u5e03\u6210\u529f");var c=d.closest(".box-upper"),e=c.find("#inline-form-type").val();c.find("a.btn."+e).text(function(a,b){var c=b.match(/^(.+)\((\d+)\)$/);return null==c?b:c[2]?c[1]+"("+(+c[2]+1)+")":void 0}),a["inline-callback"]=setTimeout(function(){$("#msg-id-inline-callback").remove()},5e3),$("#reply-weibo-form")[0].reset()}else{if(0==b.indexOf("gap")){var f=b.split(".")[1];return g({},"\u4e3a\u9632\u5237\u5c4f\uff0c\u8bf7\u7b49\u5f85 "+f+" \u79d2\uff0c\u518d\u53d1\u5e03\u65b0\u6811\u6d1e"),!1}if("other"==b)return g({},"other"),!1;g({},"\u7a0b\u5e8f\u9519\u8bef\uff1a"+b)}},g=function(b,c){"other"==c&&(c="\u5b57\u6570\u8fc7\u591a\uff0c\u6216\u8005\u5fae\u535a\u7cfb\u7edf\u7e41\u5fd9\u7b49"),$("#msg-id-inline-callback").removeClass("progress-bar-striped active"),$("#inline-form").show(),$("#reply").focus(),$("#msg-id-inline-callback").addClass("error pointer").click(function(){return $(this).remove(),!1}).find("p:first").text("\u53d1\u5e03\u5931\u8d25\uff08"+c+"\uff09"),a["inline-callback"]=setTimeout(function(){$("#msg-id-inline-callback").remove()},1e4)};return $("#msg-id-inline-callback").remove(),$(this).closest(".box").after('<div id="msg-id-inline-callback" class="box progress-bar-striped active"><div class="box-content center"><p>\u6b63\u5728\u53d1\u5e03</p></div></div>'),j(),clearTimeout(a["inline-callback"]),b?setTimeout(function(){Math.random()>.3?f("fakeajax"):g({},"\u4e3a\u9632\u5237\u5c4f\uff0c\u8bf7\u7b49\u5f85 3 \u79d2\uff0c\u518d\u53d1\u5e03\u65b0\u6811\u6d1e")},2e3):$(this).ajaxSubmit({data:{ajax:!0},dataType:"text",success:f,error:g}),!1}),$("#contact-form").submit(function(a){if(a.preventDefault(),"jznest@qq.com"==$("#contact-email").val().toLowerCase())return m("\u611f\u89c9\u81ea\u5df1\u840c\u840c\u54d2\uff1f\u8bf7\u6362\u4e2a E-mail \u5730\u5740\u3002","contact-failure","error",5e3,$("#contact-form")),$("#contact-email").focus(),!1;if(""==$("#contact-message").val())return $("#contact-message").focus(),!1;var c=function(){m("\u53d1\u9001\u6210\u529f","contact-success","success",3e3,$("#contact-form")),$("#contact-form")[0].reset()},d=function(a,b){$("#contact-message").focus(),m("\u53d1\u9001\u5931\u8d25\uff08"+b+"\uff09","contact-failure","error",5e3,$("#contact-form"))};return b?c():$(this).ajaxSubmit({dataType:"json",success:c,error:d}),!1}),$(window).on("hashchange",function(){"#contact-block"==location.hash&&$("#contact-message").focus()}).trigger("hashchange"),$("#content .box").each(function(a,b){i($(b))}),o(document),"undefined"!=typeof localStorage&&($("#status").val()||"undefined"==typeof localStorage.jzth_status||""==localStorage.jzth_status||$("#status").val(localStorage.jzth_status),"off"==localStorage.jzth_nwopened&&$("#new-weibo-close").click())});