/*
Jinzhong_Nest Web index.js
By @Phy25 - 2014/10/06+2
*/
$(function(){function d(){var a,b,c,d,f;if(e())return!1;if(a=document.body||document.documentElement,b=a.style,c="transition","string"==typeof b[c])return!0;for(d=["Moz","webkit","Webkit","Khtml","O","ms"],c=c.charAt(0).toUpperCase()+c.substr(1),f=0;f<d.length;f++)if("string"==typeof b[d[f]+c])return!0;return!1}function e(){var a="track"in document.createElement("track"),b="scoped"in document.createElement("style"),c="v8Locale"in window,d=function(a,b,c,d){var e=window.navigator.mimeTypes;for(i in e)if(e[i][a]==b){if(void 0!==c&&d.test(e[i][c]))return!0;if(void 0===c)return!0}return!1};if(!d("type","application/vnd.chromium.remoting-viewer")&&window.chrome&&a){if(!b&&!c&&/Gecko\)\s+Chrome/.test(window.navigator.appVersion))return!0;if(b&&c)return!0}return!1}function g(a,b,c){var d=!1;/@[\u4e00-\u9fa5a-zA-Z0-9_-]{1,30}/.test(a)&&("cr"==b?($("#reply").val(a.replace(/@(.)/g,"@ $1")),n("为了避免骚扰，评论 / 转发不能 @ 人，如有需要请实名操作。你可以继续发布本内容。","weibo-content-hint","error",5e3,c),d=!0):"undefined"!=typeof localStorage&&"off"!==localStorage["jzth_mention_hint"]&&(o("@ 完人，请记得打空格，否则是 @ 不到的。 "+("undefined"!=typeof localStorage?'<a href="javascript:void(0)" id="msg-id-weibo-mention-btn">不再提醒</a>':""),"weibo-content-hint","error",8e3,c),$("#msg-id-weibo-mention-btn").on("click",function(){localStorage["jzth_mention_hint"]="off",$("#msg-id-weibo-content-hint").remove()}),d=!0)),/@.+[^\u4e00-\u9fa5a-zA-Z0-9_-]/.test(a)&&($("#msg-id-weibo-content-hint").remove(),d=!1),(-1!=a.indexOf("树洞")||-1!=a.indexOf("洞主")||-1!=a.indexOf("@ 金中_Nest")||-1!=a.indexOf("@金中_Nest")&&!d)&&o('树洞问题，不妨<a href="#contact-block">直接跟洞主交流</a>哦。你可以继续发布本内容。',"weibo-content-hint","error",5e3,c)}function j(a){a.attr("id")&&(a.find("a.btn.repost").click(function(){if($("#msg-id-inline-callback.active").length)return!1;if($("#inline-form").is(".active")&&"repost"==$("#inline-form-type").val()&&$("#inline-form").closest(".box").attr("id")==$(this).closest(".box").attr("id"))return k(),!1;var a=$("#inline-form").appendTo($(this).closest(".box-upper")).show();return l(a,$(this).closest(".box"),"repost"),!1}),a.find("a.btn.comment").click(function(){if($("#msg-id-inline-callback.active").length)return!1;if($("#inline-form").is(".active")&&"comment"==$("#inline-form-type").val()&&$("#inline-form").closest(".box").attr("id")==$(this).closest(".box").attr("id"))return k(),!1;var a=$("#inline-form").appendTo($(this).closest(".box-upper")).show();return l(a,$(this).closest(".box"),"comment"),!1}));var b=a.find(".box-content-e p:first");b.html(function(b,c){var e,f,g,d=c.match(/^(.*)►(.+)$/);return null!==d?(e=$.trim(d[2]),f=$.trim(d[1])):(g=c.match(/^(.*)「(.+)」$/),null!==g?(e=$.trim(g[2]),f=$.trim(g[1])):(e="Admin",f=c)),"wx"==e&&(e="WeChat"),"web"==e&&(e="Web"),a.find("span.source").text("#"+e),$.trim(f)}),b.html(function(a,b){return b.replace(/@([\u4e00-\u9fa5a-zA-Z0-9_-]{1,30})/g,function(a,b){return'<a href="http://weibo.com/n/'+encodeURIComponent(b)+'" target="_blank" class="mention">@'+b+"</a>"})})}function k(){$("#inline-form").removeClass("active").slideUp(),$("#reply").blur()}function l(a,b,c){"object"==typeof b?($p=b,b=$p.attr("id")):$p=!1,a.find("#inline-form-type").val(c),a.find("#inline-form-parent-id").val(b),a.addClass("active"),"comment"==c&&(a.find("span.typetext").text("评论"),a.find("#inline-form-submit").text("匿名评论")),"repost"==c&&(a.find("span.typetext").text("转发"),a.find("#inline-form-submit").text("匿名转发")),$p&&a.find("a.backlink").attr("href",$p.find("a.morelink").attr("href")+"?type="+c),$("#reply").focus()}function m(a,b){var c,d;return a.source||(a.source="Web"),c='<div class="box"'+(a.id?' id="'+a.id+'"':"")+'><div class="box-content-e"><p>'+$("<div/>").text(a.content).html()+'</p></div><div class="box-upper"><div class="left time"><p><time>'+a.createdAt+'</time> <span class="source">#'+a.source+'</span> <a href="'+a.link+'" target="_blank" class="btn morelink" title="返回微博看图、点赞">更多</a></p></div><div class="right"><p><a href="'+a.link+'?type=repost" class="btn repost">转发('+a.repCount+')</a><a href="'+a.link+'?type=comment" class="btn comment">评论('+a.cmtCount+")</a></p></div></div></div>",b?(d=$(c),j(d),d):c}function n(b,c,d,e,f){var g;d||(d="error"),void 0===e&&(e=5e3),$("#msg-id-"+c).length?(g=$("#msg-id-"+c).find("p:first").text(b).end(),clearTimeout(a["msg-id-"+c]),f&&f.after(g)):(g=$('<div id="msg-id-'+c+'" class="box pointer '+d+'"><div class="box-content center"><p>'+$("<div/>").text(b).html()+"</p></div></div>").on("click",function(){$(this).remove()}),f?f.after(g):g.prependTo("#content")),0!==e&&(a["msg-id-"+c]=setTimeout(function(){g.remove()},e))}function o(b,c,d,e,f){var g;d||(d="error"),void 0===e&&(e=5e3),$("#msg-id-"+c).length?(g=$("#msg-id-"+c).find("p:first").html(b).end(),clearTimeout(a["msg-id-"+c]),f&&f.after(g)):(g=$('<div id="msg-id-'+c+'" class="box pointer '+d+'"><div class="box-content center"><p>'+b+"</p></div></div>").on("click",function(){$(this).remove()}),f?f.after(g):g.prependTo("#content")),0!==e&&(a["msg-id-"+c]=setTimeout(function(){g.remove()},e))}function p(a){return $("a.ajax",a).click(function(a){var b,c,d;return"undefined"!=typeof operamini?!0:(a.preventDefault(),$("#ajaxContent").length||$("#content").before('<div id="ajaxContent"></div>'),b=$("#ajaxContent").html('<div class="box progress-bar-striped active"><div class="box-content center"><p>正在加载</p></div></div>'),window.scrollTo(0,0),c=function(a){var c;b.empty().hide(),c="object"==typeof a?$(a):$("<div>").append(a.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"")),b.append(p(c.find("#content").children())).slideDown()},d=function(a){var c=b.find(".box.active:first");c.addClass("error pointer").removeClass("progress-bar-striped active").find("p:first").text("载入错误（"+a.statusText+", "+a.status+"）"),c.click(function(){return $(this).remove(),!1})},$.get(this.href).done(c).error(d),!1)}),a}var h,a={},b=!1,c="3173227132",f=function(){var a=function(a){try{return a.replace(/^\s+|\s+$/g,"")}catch(b){return a}},b=function(a){if("undefined"==typeof a)return 0;var b=a.match(/[^\x00-\x80]/g);return a.length+(b?b.length:0)};return function(c,d){var e,f,g,h,i,j,k,l,m;if(d=d||{},d.max=d.max||140,d.min=d.min||41,d.surl=d.surl||20,e=a(c).length,e>0){for(f=d.min,g=d.max,h=d.surl,i=c,j=c.match(/(http|https):\/\/[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)+([-A-Z0-9a-z\$\.\+\!\_\*\(\)\/\,\:;@&=\?~#%]*)*/gi)||[],k=0,l=0,e=j.length;e>l;l++)m=b(j[l]),/^(http:\/\/t.cn)/.test(j[l])||(k+=/^(http:\/\/)+(weibo.com|weibo.cn)/.test(j[l])?f>=m?m:g>=m?h:m-g+h:g>=m?h:m-g+h,i=i.replace(j[l],""));return Math.ceil((k+b(i))/2)}return 0}}();$("#new-weibo-cover").click(function(){$(this).is(".active")||(setTimeout(function(){$("#new-weibo-cover").removeClass("progress-bar-striped success error")},600),$("#new-weibo-outer").addClass("on"),$("#status").focus(),"undefined"!=typeof localStorage&&(localStorage["jzth_nwopened"]="on"))}),$("#new-weibo-close").click(function(){$("#new-weibo-outer").removeClass("on"),"undefined"!=typeof localStorage&&(localStorage["jzth_nwopened"]="off")}),$("#new-weibo-content").on("keydown",function(a){return 27==a.keyCode?($("#new-weibo-close").click(),$("#new-weibo-cover").focus(),a.preventDefault(),!1):13==a.keyCode&&1==a.ctrlKey?($("#new-weibo-form").submit(),a.preventDefault(),!1):void 0}),$("#status").on("keyup keydown paste change",function(a,b){var c=136-f(this.value);$("#new-weibo-counter").text(c)[0>c?"addClass":"removeClass"]("warning"),b||"undefined"==typeof localStorage||(localStorage["jzth_status"]=this.value),g(this.value,"weibo",$("#new-weibo-outer"))}).trigger("paste",[!0]),h=function(){var b=$("#pic")[0],c=b.files&&b.files[0]?b.files[0].name:b.value;c?$("#new-weibo-upload-btn").addClass("selected").attr("title","已选取图片文件 "+c):$("#new-weibo-upload-btn").removeClass("selected").attr("title","上传图片文件")},$("#pic").on("change",h),$("#new-weibo-form").on("reset",function(){setTimeout(function(){h(),$("#status").trigger("change")},0)}),$("#new-weibo-upload-btn").click(function(){return $("#pic").click(),!1}),$("#new-weibo-close").keyup(function(a){13==a.keyCode&&$("#new-weibo-cover").focus()}),$("#new-weibo-reset").click(function(){$("#status").focus()}),$("#new-weibo-cover").keydown(function(a){return 13==a.keyCode?($(this).click(),a.preventDefault(),!1):void 0}),d()||($("#new-weibo-cover").hide(),$("#new-weibo-cover").click(function(){$(this).is(".active")||($("#new-weibo-cover").hide(),$("#new-weibo-content").show(),$("#status").focus())}),$("#new-weibo-close").click(function(){$("#new-weibo-content").hide(),$("#new-weibo-cover").show()})),$("#new-weibo-form").submit(function(d){var e,g;return"undefined"!=typeof operamini?!0:(d.preventDefault(),0==f($("#status").val())?($("#status").val("").focus(),d.preventDefault(),!1):$("#new-weibo-counter").is(".warning")?(n("字数过多，请不要做话痨 :)","new-weibo-length","error",3e3),$("#status").focus(),d.preventDefault(),!1):($("#msg-id-new-weibo-failure").remove(),e=function(b){var d,e,f,h,i,j,k,l,n,o;if(0==b.indexOf("okay")||"fakeajax"==b)d=b.split("."),e=!1,"fakeajax"!=b&&d[1]?(d[2]&&(e=d[2]),d=d[1]):d=!1,$("#new-weibo-cover").removeClass("progress-bar-striped active").addClass("success"),$("#new-weibo-progress").text("发布成功"),f=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],h=new Date,i=f[h.getMonth()],j=h.getDate(),k=h.getHours(),l=h.getMinutes(),n=h.getSeconds(),10>j&&(j="0"+j),10>k&&(k="0"+k),10>l&&(l="0"+l),10>n&&(n="0"+n),o=i+" "+j+" "+k+":"+l+":"+n,m({content:$("#status").val()+" 「web」",createdAt:o,cmtCount:0,repCount:0,link:"http://weibo.com/"+c+"/"+(d!==!1?d:""),id:e},!0).hide().prependTo("#content").slideDown(),a["new-weibo-callback"]=setTimeout(function(){$("#new-weibo-cover").removeClass("success")},5e3),$("#new-weibo-form")[0].reset();else{if(0==b.indexOf("gap"))return d=b.split(".")[1],g({},"为防刷屏，请等待 "+d+" 秒，再发布新树洞"),!1;if("other"==b)return g({},"other"),!1;g({},"程序错误："+b)}},g=function(a,b){"other"==b&&(b="字数过多，图片格式有误，或微博系统繁忙等"),$("#new-weibo-cover").removeClass("progress-bar-striped active"),$("#status").focus(),$("#new-weibo-cover").click(),n("发布失败（"+b+"）","new-weibo-failure","error",0)},$("#new-weibo-progress").text("正在发布"),$("#new-weibo-cover").addClass("progress-bar-striped active"),$("#new-weibo-close").click(),$("#status").blur(),$("#msg-id-weibo-content-hint").remove(),clearTimeout(a["new-weibo-callback"]),b?setTimeout(function(){Math.random()>.3?e("fakeajax"):g({},"为防刷屏，请等待 3 秒，再发布新树洞")},2e3):$(this).ajaxSubmit({data:{ajax:!0},dataType:"text",success:e,error:g}),!1))}),$("#reply-weibo-form").on("keydown",function(a){return 27==a.keyCode?(k(),a.preventDefault(),!1):13==a.keyCode&&1==a.ctrlKey?($("#reply-weibo-form").submit(),a.preventDefault(),!1):void 0}),$("#reply").on("keydown change",function(){g(this.value,"cr",$(this).closest(".box"))}),$("#reply-weibo-form").submit(function(c){var d,e,g;return"undefined"!=typeof operamini?!0:(d=$(this),c.preventDefault(),0==f($("#reply").val())?($("#reply").val("").focus(),!1):f($("#reply").val())>136?(n("字数过多，请不要做话痨 :)","new-weibo-length","error",3e3,$(this).closest(".box")),$("#reply").focus(),!1):(e=function(b){var c,e,f;if("okay"==b||"fakeajax"==b)$("#msg-id-inline-callback").removeClass("progress-bar-striped active").addClass("success pointer").click(function(){return $(this).remove(),!1}).find("p:first").text("发布成功"),c=d.closest(".box-upper"),e=c.find("#inline-form-type").val(),c.find("a.btn."+e).text(function(a,b){var c=b.match(/^(.+)\((\d+)\)$/);return null==c?b:c[2]?c[1]+"("+(+c[2]+1)+")":void 0}),a["inline-callback"]=setTimeout(function(){$("#msg-id-inline-callback").remove()},5e3),$("#reply-weibo-form")[0].reset();else{if(0==b.indexOf("gap"))return f=b.split(".")[1],g({},"为防刷屏，请等待 "+f+" 秒，再发布新树洞"),!1;if("other"==b)return g({},"other"),!1;g({},"程序错误："+b)}},g=function(b,c){"other"==c&&(c="字数过多，或者微博系统繁忙等"),$("#msg-id-inline-callback").removeClass("progress-bar-striped active"),$("#inline-form").show(),$("#reply").focus(),$("#msg-id-inline-callback").addClass("error pointer").click(function(){return $(this).remove(),!1}).find("p:first").text("发布失败（"+c+"）"),a["inline-callback"]=setTimeout(function(){$("#msg-id-inline-callback").remove()},1e4)},$("#msg-id-inline-callback").remove(),$(this).closest(".box").after('<div id="msg-id-inline-callback" class="box progress-bar-striped active"><div class="box-content center"><p>正在发布</p></div></div>'),k(),clearTimeout(a["inline-callback"]),b?setTimeout(function(){Math.random()>.3?e("fakeajax"):g({},"为防刷屏，请等待 3 秒，再发布新树洞")},2e3):$(this).ajaxSubmit({data:{ajax:!0},dataType:"text",success:e,error:g}),!1))}),$("#contact-form").submit(function(a){if(a.preventDefault(),"jznest@qq.com"==$("#contact-email").val())return n("感觉自己萌萌哒？请换个 E-mail 地址。","contact-failure","error",3e3,$("#contact-block")),$("#contact-email").focus(),!1;if(""==$("#contact-message").val())return $("#contact-message").focus(),!1;var c=function(){n("发送成功","contact-success","success",3e3,$("#contact-form")),$("#contact-form")[0].reset()},d=function(a,b){$("#contact-message").focus(),n("发送失败（"+b+"）","contact-failure","error",5e3,$("#contact-form"))};return b?c():$(this).ajaxSubmit({dataType:"json",success:c,error:d}),!1}),$(window).on("hashchange",function(){"#contact-block"==location.hash&&$("#contact-message").focus()}).trigger("hashchange"),$("#content .box").each(function(a,b){j($(b))}),p(document),"undefined"!=typeof localStorage&&($("#status").val()||"undefined"==typeof localStorage["jzth_status"]||""==localStorage["jzth_status"]||$("#status").val(localStorage["jzth_status"]),"off"==localStorage["jzth_nwopened"]&&$("#new-weibo-close").click())});