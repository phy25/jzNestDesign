/*
Jinzhong_Nest Web index.min.js
By @Phy25 - 2014/10/04
Other credits left through the script
*/
$(function(){function e(){if(t())return!1;var e=document.body||document.documentElement,n=e.style,i="transition";if("string"==typeof n[i])return!0;var o=["Moz","webkit","Webkit","Khtml","O","ms"];i=i.charAt(0).toUpperCase()+i.substr(1);for(var r=0;r<o.length;r++)if("string"==typeof n[o[r]+i])return!0;return!1}function t(){var e="track"in document.createElement("track"),t="scoped"in document.createElement("style"),n="v8Locale"in window,o=function(e,t,n,o){var r=window.navigator.mimeTypes;for(i in r)if(r[i][e]==t){if(void 0!==n&&o.test(r[i][n]))return!0;if(void 0===n)return!0}return!1};if(!o("type","application/vnd.chromium.remoting-viewer")&&window.chrome&&e){if(!t&&!n&&/Gecko\)\s+Chrome/.test(window.navigator.appVersion))return!0;if(t&&n)return!0}return!1}function n(e,t,n){/@\S/.test(e)&&("cr"==t?($("#reply").val(e.replace(/@(\S)/g,"@ $1")),c("为了避免骚扰，评论 / 转发不能 @ 人，如有需要请实名操作。你可以继续发布本内容。","weibo-content-hint","error",5e3,n)):"undefined"!=typeof localStorage&&"off"!==localStorage.jzth_mention_hint&&(l("@ 完人，请记得打空格，否则是 @ 不到的。 "+("undefined"!=typeof localStorage?'<a href="javascript:void(0)" id="msg-id-weibo-mention-btn">不再提醒</a>':""),"weibo-content-hint","error",0,n),$("#msg-id-weibo-mention-btn").on("click",function(){localStorage.jzth_mention_hint="off",$("#msg-id-weibo-content-hint").remove()}))),/@.+\s/.test(e)&&$("#msg-id-weibo-content-hint").length&&$("#msg-id-weibo-content-hint").remove(),(-1!=e.indexOf("树洞")||-1!=e.indexOf("洞主"))&&c("树洞问题，不妨在页面左侧直接跟洞主交流哦。你可以继续发布本内容。","weibo-content-hint","error",5e3,n)}function o(e){e.attr("id")&&(e.find("a.btn.repost").click(function(){if($("#msg-id-inline-callback.active").length)return!1;if($("#inline-form").is(".active")&&"repost"==$("#inline-form-type").val()&&$("#inline-form").closest(".box").attr("id")==$(this).closest(".box").attr("id"))return r(),!1;var e=$("#inline-form").appendTo($(this).closest(".box-upper")).show();return a(e,$(this).closest(".box"),"repost"),!1}),e.find("a.btn.comment").click(function(){if($("#msg-id-inline-callback.active").length)return!1;if($("#inline-form").is(".active")&&"comment"==$("#inline-form-type").val()&&$("#inline-form").closest(".box").attr("id")==$(this).closest(".box").attr("id"))return r(),!1;var e=$("#inline-form").appendTo($(this).closest(".box-upper")).show();return a(e,$(this).closest(".box"),"comment"),!1}));var t=e.find(".box-content-e p:first");t.html(function(t,n){var i,o,r=n.match(/^(.*)「(.+)」$/);return null!==r?(i=r[2],o=r[1]):(i="Admin",o=n),"wx"==i&&(i="WeChat"),"web"==i&&(i="Web"),e.find("span.source").text("#"+i),$.trim(o)})}function r(){$("#inline-form").removeClass("active").slideUp(),$("#reply").blur()}function a(e,t,n){"object"==typeof t?($p=t,t=$p.attr("id")):$p=!1,e.find("#inline-form-type").val(n),e.find("#inline-form-parent-id").val(t),e.addClass("active"),"comment"==n&&(e.find("span.typetext").text("评论"),e.find("#inline-form-submit").text("匿名评论")),"repost"==n&&(e.find("span.typetext").text("转发"),e.find("#inline-form-submit").text("匿名转发")),$p&&e.find("a.backlink").attr("href",$p.find("a.morelink").attr("href")+"?type="+n),$("#reply").focus()}function s(e,t){e.source||(e.source="Web");var n='<div class="box"'+(e.id?' id="'+e.id+'"':"")+'><div class="box-content-e"><p>'+$("<div/>").text(e.content).html()+'</p></div><div class="box-upper"><div class="left time"><p><time>'+e.createdAt+'</time> <span class="source">#'+e.source+'</span> <a href="'+e.link+'" target="_blank" class="btn morelink" title="返回微博看图、点赞">更多</a></p></div><div class="right"><p><a href="'+e.link+'?type=repost" class="btn repost">转发('+e.repCount+')</a><a href="'+e.link+'?type=comment" class="btn comment">评论('+e.cmtCount+")</a></p></div></div></div>";if(t){var i=$(n);return o(i),i}return n}function c(e,t,n,i,o){if(!n)var n="error";if(void 0===i)var i=5e3;if($("#msg-id-"+t).length){var r=$("#msg-id-"+t).find("p:first").text(e).end();clearTimeout(f["msg-id-"+t]),o&&o.after(r)}else{var r=$('<div id="msg-id-'+t+'" class="box pointer '+n+'"><div class="box-content center"><p>'+$("<div/>").text(e).html()+"</p></div></div>").on("click",function(){$(this).remove()});o?o.after(r):r.prependTo("#content")}0!==i&&(f["msg-id-"+t]=setTimeout(function(){r.remove()},i))}function l(e,t,n,i,o){if(!n)var n="error";if(void 0===i)var i=5e3;if($("#msg-id-"+t).length){var r=$("#msg-id-"+t).find("p:first").html(e).end();clearTimeout(f["msg-id-"+t]),o&&o.after(r)}else{var r=$('<div id="msg-id-'+t+'" class="box pointer '+n+'"><div class="box-content center"><p>'+e+"</p></div></div>").on("click",function(){$(this).remove()});o?o.after(r):r.prependTo("#content")}0!==i&&(f["msg-id-"+t]=setTimeout(function(){r.remove()},i))}function u(e){return $("a.ajax",e).click(function(e){if("undefined"!=typeof operamini)return!0;e.preventDefault(),$("#ajaxContent").length||$("#content").before('<div id="ajaxContent"></div>');var t=$("#ajaxContent").html('<div class="box progress-bar-striped active"><div class="box-content center"><p>正在加载</p></div></div>');window.scrollTo(0,0);var n=function(e){if(t.empty().hide(),"object"==typeof e)var n=$(e);else var n=$("<div>").append(e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,""));t.append(u(n.find("#content").children())).slideDown()},i=function(e){var n=t.find(".box.active:first");n.addClass("error pointer").removeClass("progress-bar-striped active").find("p:first").text("载入错误（"+e.statusText+", "+e.status+"）"),n.click(function(){return $(this).remove(),!1})};return $.get(this.href).done(n).error(i),!1}),e}var f={},d=!0,p="3173227132",v=function(){var e=function(e){try{return e.replace(/^\s+|\s+$/g,"")}catch(t){return e}},t=function(e){if(void 0===e)return 0;var t=e.match(/[^\x00-\x80]/g);return e.length+(t?t.length:0)};return function(n,i){i=i||{},i.max=i.max||140,i.min=i.min||41,i.surl=i.surl||20;var o=e(n).length;if(o>0){for(var r=i.min,a=i.max,s=i.surl,c=n,l=n.match(/(http|https):\/\/[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)+([-A-Z0-9a-z\$\.\+\!\_\*\(\)\/\,\:;@&=\?~#%]*)*/gi)||[],u=0,f=0,o=l.length;o>f;f++){var d=t(l[f]);/^(http:\/\/t.cn)/.test(l[f])||(u+=/^(http:\/\/)+(weibo.com|weibo.cn)/.test(l[f])?d>r?d>a?d-a+s:s:d:d>a?d-a+s:s,c=c.replace(l[f],""))}return Math.ceil((u+t(c))/2)}return 0}}();$("#new-weibo-cover").click(function(){$(this).is(".active")||(setTimeout(function(){$("#new-weibo-cover").removeClass("progress-bar-striped success error")},600),$("#new-weibo-outer").addClass("on"),$("#status").focus(),"undefined"!=typeof localStorage&&(localStorage.jzth_nwopened="on"))}),$("#new-weibo-close").click(function(){$("#new-weibo-outer").removeClass("on"),"undefined"!=typeof localStorage&&(localStorage.jzth_nwopened="off")}),$("#new-weibo-content").on("keydown",function(e){return 27==e.keyCode?($("#new-weibo-close").click(),$("#new-weibo-cover").focus(),e.preventDefault(),!1):13==e.keyCode&&1==e.ctrlKey?($("#new-weibo-form").submit(),e.preventDefault(),!1):void 0}),$("#status").on("keyup keydown paste change",function(e,t){var i=136-v(this.value);$("#new-weibo-counter").text(i)[0>i?"addClass":"removeClass"]("warning"),t||"undefined"==typeof localStorage||(localStorage.jzth_status=this.value),n(this.value,"weibo",$("#new-weibo-outer"))}).trigger("paste",[!0]);var m=function(){var e=$("#pic")[0],t=e.files&&e.files[0]?e.files[0].name:e.value;t?$("#new-weibo-upload-btn").addClass("selected").attr("title","已选取图片文件 "+t):$("#new-weibo-upload-btn").removeClass("selected").attr("title","上传图片文件")};$("#pic").on("change",m),$("#new-weibo-form").on("reset",function(){setTimeout(function(){m(),$("#status").trigger("change")},0)}),$("#new-weibo-upload-btn").click(function(){return $("#pic").click(),!1}),$("#new-weibo-close").keyup(function(e){13==e.keyCode&&$("#new-weibo-cover").focus()}),$("#new-weibo-reset").click(function(){$("#status").focus()}),$("#new-weibo-cover").keydown(function(e){return 13==e.keyCode?($(this).click(),e.preventDefault(),!1):void 0}),e()||($("#new-weibo-cover").hide(),$("#new-weibo-cover").click(function(){$(this).is(".active")||($("#new-weibo-cover").hide(),$("#new-weibo-content").show(),$("#status").focus())}),$("#new-weibo-close").click(function(){$("#new-weibo-content").hide(),$("#new-weibo-cover").show()})),$("#new-weibo-form").submit(function(e){if("undefined"!=typeof operamini)return!0;if(e.preventDefault(),0==v($("#status").val()))return $("#status").val("").focus(),e.preventDefault(),!1;if($("#new-weibo-counter").is(".warning"))return c("字数过多，请不要做话痨 :)","new-weibo-length","error",3e3),$("#status").focus(),e.preventDefault(),!1;$("#msg-id-new-weibo-failure").remove();var t=function(e){if(0==e.indexOf("okay")||"fakeajax"==e){var t=e.split("."),i=!1;"fakeajax"!=e&&t[1]?(t[2]&&(i=t[2]),t=t[1]):t=!1,$("#new-weibo-cover").removeClass("progress-bar-striped active").addClass("success"),$("#new-weibo-progress").text("发布成功");var o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],r=new Date,a=o[r.getMonth()],c=r.getDate(),l=r.getHours(),u=r.getMinutes(),d=r.getSeconds();10>l&&(l="0"+l),10>u&&(u="0"+u),10>d&&(d="0"+d);var v=a+" "+c+" "+l+":"+u+":"+d;s({content:$("#status").val()+" 「web」",createdAt:v,cmtCount:0,repCount:0,link:"http://weibo.com/"+p+"/"+(t!==!1?t:""),id:i},!0).hide().prependTo("#content").slideDown(),f["new-weibo-callback"]=setTimeout(function(){$("#new-weibo-cover").removeClass("success")},5e3),$("#new-weibo-form")[0].reset()}else{if(0==e.indexOf("gap")){var t=e.split(".")[1];return n({},"为防刷屏，请等待 "+t+" 秒，再发布新树洞"),!1}if("other"==e)return n({},"other"),!1;n({},"程序错误："+e)}},n=function(e,t){"other"==t&&(t="字数过多，图片格式有误，或微博系统繁忙等"),$("#new-weibo-cover").removeClass("progress-bar-striped active"),$("#status").focus(),$("#new-weibo-cover").click(),c("发布失败（"+t+"）","new-weibo-failure","error",0)};return $("#new-weibo-progress").text("正在发布"),$("#new-weibo-cover").addClass("progress-bar-striped active"),$("#new-weibo-close").click(),$("#status").blur(),clearTimeout(f["new-weibo-callback"]),d?setTimeout(function(){Math.random()>.3?t("fakeajax"):n({},"为防刷屏，请等待 3 秒，再发布新树洞")},2e3):$(this).ajaxSubmit({data:{ajax:!0},dataType:"text",success:t,error:n}),!1}),$("#reply-weibo-form").on("keydown",function(e){return 27==e.keyCode?(r(),e.preventDefault(),!1):13==e.keyCode&&1==e.ctrlKey?($("#reply-weibo-form").submit(),e.preventDefault(),!1):void 0}),$("#reply").on("keydown change",function(){n(this.value,"cr",$(this).closest(".box"))}),$("#reply-weibo-form").submit(function(e){if("undefined"!=typeof operamini)return!0;var t=$(this);if(e.preventDefault(),0==v($("#reply").val()))return $("#reply").val("").focus(),!1;if(v($("#reply").val())>136)return c("字数过多，请不要做话痨 :)","new-weibo-length","error",3e3,$(this).closest(".box")),$("#reply").focus(),!1;var n=function(e){if("okay"==e||"fakeajax"==e){$("#msg-id-inline-callback").removeClass("progress-bar-striped active").addClass("success pointer").click(function(){return $(this).remove(),!1}).find("p:first").text("发布成功");var n=t.closest(".box-upper"),o=n.find("#inline-form-type").val();n.find("a.btn."+o).text(function(e,t){var n=t.match(/^(.+)\((\d+)\)$/);return null==n?t:n[2]?n[1]+"("+(+n[2]+1)+")":void 0}),f["inline-callback"]=setTimeout(function(){$("#msg-id-inline-callback").remove()},5e3),$("#reply-weibo-form")[0].reset()}else{if(0==e.indexOf("gap")){var r=e.split(".")[1];return i({},"为防刷屏，请等待 "+r+" 秒，再发布新树洞"),!1}if("other"==e)return i({},"other"),!1;i({},"程序错误："+e)}},i=function(e,t){"other"==t&&(t="字数过多，或者微博系统繁忙等"),$("#msg-id-inline-callback").removeClass("progress-bar-striped active"),$("#inline-form").show(),$("#reply").focus(),$("#msg-id-inline-callback").addClass("error pointer").click(function(){return $(this).remove(),!1}).find("p:first").text("发布失败（"+t+"）"),f["inline-callback"]=setTimeout(function(){$("#msg-id-inline-callback").remove()},1e4)};return $("#msg-id-inline-callback").remove(),$(this).closest(".box").after('<div id="msg-id-inline-callback" class="box progress-bar-striped active"><div class="box-content center"><p>正在发布</p></div></div>'),r(),clearTimeout(f["inline-callback"]),d?setTimeout(function(){Math.random()>.3?n("fakeajax"):i({},"为防刷屏，请等待 3 秒，再发布新树洞")},2e3):$(this).ajaxSubmit({data:{ajax:!0},dataType:"text",success:n,error:i}),!1}),$("#contact-form").submit(function(e){return e.preventDefault(),$(this).ajaxSubmit({dataType:"json",success:function(){c("发送成功","contact-success","success",3e3,$("#contact-block"))},error:function(e,t){$("#contact-message").focus(),c("发送失败（"+t+"）","contact-failure","error",3e3,$("#contact-block"))}}),!1}),$("#content .box").each(function(e,t){o($(t))}),u(document),"undefined"!=typeof localStorage&&($("#status").val()||""==localStorage.jzth_status||$("#status").val(localStorage.jzth_status),"off"==localStorage.jzth_nwopened&&$("#new-weibo-close").click())});